-----

# üöÄ Azure Multi-IP Policy-Based Routing (PBR) Setup

–¶–µ–π –ø—Ä–æ–µ–∫—Ç –∞–≤—Ç–æ–º–∞—Ç–∏–∑—É—î —Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–æ—ó –º–∞—à–∏–Ω–∏ $\text{Linux}$ –≤ $\text{Azure}$ –∑ –∫—ñ–ª—å–∫–æ–º–∞ –ø—É–±–ª—ñ—á–Ω–∏–º–∏ $\text{IP}$-–∞–¥—Ä–µ—Å–∞–º–∏ —Ç–∞ –Ω–∞–ª–∞—à—Ç–æ–≤—É—î $\text{Policy}$-$\text{Based}$ $\text{Routing}$ ($\text{PBR}$) –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é $\text{Ansible}$. –¶–µ –≥–∞—Ä–∞–Ω—Ç—É—î, —â–æ —Ç—Ä–∞—Ñ—ñ–∫, —è–∫–∏–π –≤–∏—Ö–æ–¥–∏—Ç—å –∑ –∫–æ–∂–Ω–æ—ó –ø—Ä–∏–≤–∞—Ç–Ω–æ—ó $\text{IP}$-–∞–¥—Ä–µ—Å–∏-$\text{–∞–ª—ñ–∞—Å–∞}$ –Ω–∞ $\text{VM}$, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—É —ó–π —É–Ω—ñ–∫–∞–ª—å–Ω—É –ø—É–±–ª—ñ—á–Ω—É $\text{IP}$-–∞–¥—Ä–µ—Å—É.

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ü—Ä–æ–µ–∫—Ç—É

```
.
‚îú‚îÄ‚îÄ ansible/
‚îÇ   ‚îú‚îÄ‚îÄ inventory.ini             # Inventory –¥–ª—è Ansible
‚îÇ   ‚îú‚îÄ‚îÄ pbr_config.yml          # Playbook –¥–ª—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è PBR
‚îú‚îÄ‚îÄ full_task_runner.sh       # –ì–æ–ª–æ–≤–Ω–∏–π —Å–∫—Ä–∏–ø—Ç, —è–∫–∏–π –≤–∏–∫–æ–Ω—É—î –≤–µ—Å—å –ø—Ä–æ—Ü–µ—Å
‚îú‚îÄ‚îÄ ansible.cfg       		  # –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è Ansible
‚îú‚îÄ‚îÄ cleanup.sh                # –°–∫—Ä–∏–ø—Ç –¥–ª—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è —Ä–µ—Å—É—Ä—Å—ñ–≤
‚îú‚îÄ‚îÄ ip_map.txt                # (–ì–µ–Ω–µ—Ä—É—î—Ç—å—Å—è) –ú–∞–ø—ñ–Ω–≥ private:public IP
‚îú‚îÄ‚îÄ .env                      # (–ì–µ–Ω–µ—Ä—É—î—Ç—å—Å—è) –ó–º—ñ–Ω–Ω—ñ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞ –¥–ª—è Ansible
‚îú‚îÄ‚îÄ main.tf                   # Terraform: –û—Å–Ω–æ–≤–Ω–∞ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è VM, NIC —Ç–∞ IP
‚îú‚îÄ‚îÄ outputs.tf                # Terraform: –í–∏—Ö—ñ–¥–Ω—ñ –¥–∞–Ω—ñ (IPs, user, NIC name)
‚îú‚îÄ‚îÄ variables.tf              # Terraform: –ó–º—ñ–Ω–Ω—ñ –¥–ª—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è (–∫—ñ–ª—å–∫—ñ—Å—Ç—å IP, –∫–ª—é—á SSH)
‚îî‚îÄ‚îÄ verify_pbr.sh             # –°–∫—Ä–∏–ø—Ç, —â–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—î –∫–æ—Ä–µ–∫—Ç–Ω—ñ—Å—Ç—å PBR –Ω–∞ VM
```

## üìã –ü–µ—Ä–µ–¥—É–º–æ–≤–∏

–ü–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –ø–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ —É –≤–∞—Å –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —Ç–∞ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ –Ω–∞—Å—Ç—É–ø–Ω–µ:

1.  **Azure CLI** —Ç–∞ –≤–∏ –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–æ–≤–∞–Ω—ñ (`az login`).
2.  **Terraform** (`~v1.0+`).
3.  **Ansible** (`v2.9+`).
4.  **`jq`** —Ç–∞ **`paste`** (—É—Ç–∏–ª—ñ—Ç–∏ –∫–æ–º–∞–Ω–¥–Ω–æ–≥–æ —Ä—è–¥–∫–∞).
5.  **SSH –∫–ª—é—á:** –í–∞—à –ø—É–±–ª—ñ—á–Ω–∏–π SSH –∫–ª—é—á –¥–æ–¥–∞–Ω–æ –¥–æ `variables.tf`, –∞ –ø—Ä–∏–≤–∞—Ç–Ω–∏–π –∫–ª—é—á –¥–æ—Å—Ç—É–ø–Ω–∏–π –∑–∞ —à–ª—è—Ö–æ–º `~/.ssh/id_rsa`.

## ‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è

1.  **–û–Ω–æ–≤—ñ—Ç—å `variables.tf`**: –í–∫–∞–∂—ñ—Ç—å —Å–≤—ñ–π –ø—É–±–ª—ñ—á–Ω–∏–π SSH –∫–ª—é—á —É –∑–º—ñ–Ω–Ω—ñ–π `public_key`.
2.  **–ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ –≤—Å—ñ —Ñ–∞–π–ª–∏ –≤–∏–∫–æ–Ω—É–≤–∞–Ω—ñ**:
    ```bash
    chmod +x *.sh ansible/*.sh
    ```

## üöÄ –í–∏–∫–æ–Ω–∞–Ω–Ω—è –†–æ–±–æ—á–æ–≥–æ –ü—Ä–æ—Ü–µ—Å—É

–ì–æ–ª–æ–≤–Ω–∏–π —Å–∫—Ä–∏–ø—Ç **`full_task_runner.sh`** –∞–≤—Ç–æ–º–∞—Ç–∏–∑—É—î –≤—Å—ñ —Ç—Ä–∏ —Ñ–∞–∑–∏ –∑–∞–≤–¥–∞–Ω–Ω—è. –ó–∞–ø—É—Å—Ç—ñ—Ç—å –π–æ–≥–æ –∑ –∫–æ—Ä–µ–Ω–µ–≤–æ—ó –ø–∞–ø–∫–∏:


```bash
./full_task_runner.sh
```

### –î–µ—Ç–∞–ª—å–Ω—ñ –ö—Ä–æ–∫–∏, —è–∫—ñ –≤–∏–∫–æ–Ω—É—î `full_task_runner.sh`:

| –ö—Ä–æ–∫ | –î—ñ—è | –†–µ–∑—É–ª—å—Ç–∞—Ç |
| :--- | :--- | :--- |
| **1. `terraform init` / `apply`** | –†–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è —ñ–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∏ $\text{Azure}$ (–≤–∫–ª—é—á–Ω–æ –∑ $\text{VM}$ —Ç–∞ 6 $\text{IP}$-–∞–¥—Ä–µ—Å–∞–º–∏). | –°—Ç–≤–æ—Ä–µ–Ω–æ $\text{VM}$ —Ç–∞ `terraform.tfstate`. |
| **2. –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è $\text{ENV}$ —Ç–∞ $\text{Map}$** | –í–∏–∫–æ–Ω–∞–Ω–Ω—è –≤–±—É–¥–æ–≤–∞–Ω–æ—ó –ª–æ–≥—ñ–∫–∏ –¥–ª—è –∑–±–æ—Ä—É –¥–∏–Ω–∞–º—ñ—á–Ω–∏—Ö $\text{IP}$ –∑ $\text{Terraform}$ $\text{outputs}$. | –°—Ç–≤–æ—Ä–µ–Ω–æ **`.env`** —Ç–∞ **`ip_map.txt`** –∑ –º–∞–ø—ñ–Ω–≥–∞–º–∏. |
| **3. –ó–∞–ø—É—Å–∫ $\text{Ansible}$** | –ó–∞–ø—É—Å–∫ `ansible/pbr_config.yml` –∑ –¥–∏–Ω–∞–º—ñ—á–Ω–∏–º–∏ $\text{extra}$-$\text{vars}$. | $\text{PBR}$ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ –Ω–∞ $\text{VM}$ (—Å—Ç–≤–æ—Ä–µ–Ω—ñ $\text{ip}$ $\text{rules}$ —Ç–∞ $\text{rt}$ $\text{tables}$). |
| **4. –í–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—è** | –ö–æ–ø—ñ—é–≤–∞–Ω–Ω—è —Ç–∞ –≤—ñ–¥–¥–∞–ª–µ–Ω–∏–π –∑–∞–ø—É—Å–∫ `verify_pbr.sh` –Ω–∞ $\text{VM}$. | $\text{SUCCESS}$ –∞–±–æ $\text{FAILURE}$. –ü–µ—Ä–µ–≤—ñ—Ä—è—î, —á–∏ –∫–æ–∂–µ–Ω –ø—Ä–∏–≤–∞—Ç–Ω–∏–π $\text{IP}$ –≤–∏—Ö–æ–¥–∏—Ç—å —á–µ—Ä–µ–∑ —Å–≤—ñ–π –ø—É–±–ª—ñ—á–Ω–∏–π $\text{IP}$. |


## üóëÔ∏è –û—á–∏—â–µ–Ω–Ω—è –†–µ—Å—É—Ä—Å—ñ–≤

–©–æ–± –≤–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—ñ —Ä–µ—Å—É—Ä—Å–∏, —Å—Ç–≤–æ—Ä–µ–Ω—ñ $\text{Terraform}$:

```bash
./cleanup.sh
```
| –ö—Ä–æ–∫ | –î—ñ—è | –†–µ–∑—É–ª—å—Ç–∞—Ç |
| :--- | :--- | :--- |
| **5. –û—á–∏—â–µ–Ω–Ω—è** | –ó–∞–ø–∏—Ç –Ω–∞ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è `cleanup.sh`. | –í–∏–¥–∞–ª—è—î –≤—Å—ñ —Ä–µ—Å—É—Ä—Å–∏ $\text{Azure}$. |